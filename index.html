<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tama Fishing Mobile</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --water: #2c7bb6; --sky: #abd9e9; }
        body { margin: 0; background: var(--sky); font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: none; }

        /* –°—Ü–µ–Ω–∞ */
        .world { position: relative; height: 60vh; background: linear-gradient(to bottom, #74ebd5, #acb6e5); overflow: hidden; }
        .water { position: absolute; bottom: 0; width: 100%; height: 100px; background: var(--water); opacity: 0.8; z-index: 10; }

        /* –£–¥–æ—á–∫–∞ */
        .rod-container { position: absolute; right: -20px; bottom: 80px; width: 200px; height: 200px; transform: rotate(-15deg); transition: 0.5s; z-index: 5; }
        .rod-stick { width: 6px; height: 250px; background: #4b3621; border-radius: 5px; transform-origin: bottom; transition: 0.3s; }
        .line { position: absolute; top: 0; left: 3px; width: 1px; height: 180px; background: white; transform-origin: top; transition: 0.3s; }

        /* –ü–æ–ø–ª–∞–≤–æ–∫ */
        .bobber { position: absolute; bottom: -10px; left: -7px; width: 14px; height: 20px; background: red; border: 2px solid white; border-radius: 50% 50% 2px 2px; }

        /* –†—ã–±–∫–∞ */
        .fish { 
            position: absolute; width: 40px; height: 30px; background: orange; border-radius: 50% 50% 50% 50%;
            display: none; z-index: 15; left: 30%; bottom: 80px; box-shadow: 0 0 10px gold;
        }
        .fish::after { content: 'üêü'; font-size: 25px; position: absolute; top: -5px; left: 5px; }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes bite { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(15px); } }
        @keyframes rodBend { 0% { transform: rotate(0deg); } 50% { transform: rotate(15deg); } }
        @keyframes catchFish { 
            0% { bottom: 50px; left: 30%; transform: rotate(0deg); opacity: 1; }
            100% { bottom: 300px; left: 80%; transform: rotate(360deg); opacity: 0; }
        }

        .active-bite { animation: bite 0.4s infinite; }
        .active-bend { animation: rodBend 0.4s infinite; }
        .jump-fish { display: block !important; animation: catchFish 0.8s ease-out forwards; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .ui { height: 40vh; background: #1a2a6c; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; gap: 15px; }
        .btn { width: 100%; max-width: 300px; padding: 18px; border: none; border-radius: 15px; color: white; font-size: 20px; font-weight: bold; cursor: pointer; }
        .btn-go { background: #4CAF50; box-shadow: 0 5px #2d5a27; }
        .btn-go:active { transform: translateY(3px); box-shadow: 0 2px #2d5a27; }
        #status { color: #88bdff; font-weight: 500; }
    </style>
</head>
<body>

<div class="world">
    <div class="water"></div>
    <div class="rod-container" id="rodBox">
        <div class="rod-stick" id="rodStick">
            <div class="line">
                <div class="bobber" id="bobber"></div>
            </div>
        </div>
    </div>
    <div class="fish" id="fish"></div>
</div>

<div class="ui">
    <button class="btn btn-go" id="mainBtn" onclick="handleFishing()">–ó–ê–ë–†–û–°–ò–¢–¨ üé£</button>
    <button class="btn" style="background:#f44336" onclick="sendToServer('sell_fish')">–ü–†–û–î–ê–¢–¨ üí∞</button>
    <div id="status">–ì–æ—Ç–æ–≤ –∫ —Ä—ã–±–∞–ª–∫–µ</div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const SERVER_URL = 'https://tama-bot-server.onrender.com/api/action';

    async function handleFishing() {
        const btn = document.getElementById('mainBtn');
        const bobber = document.getElementById('bobber');
        const rod = document.getElementById('rodStick');
        const fish = document.getElementById('fish');
        const status = document.getElementById('status');

        btn.disabled = true;
        status.innerText = "–ó–∞–∫–∏–Ω—É–ª–∏... –ñ–¥–µ–º...";

        // 1. –ü–æ–∫–ª–µ–≤–∫–∞ —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫
        setTimeout(() => {
            bobber.classList.add('active-bite');
            rod.classList.add('active-bend');
            status.innerText = "–ö–õ–Æ–ï–¢! –¢—è–Ω–µ–º...";
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('heavy');
        }, 1500);

        // 2. –í—ã—Ç—è–≥–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫
        setTimeout(async () => {
            bobber.classList.remove('active-bite');
            rod.classList.remove('active-bend');
            
            // –ê–Ω–∏–º–∞—Ü–∏—è —Ä—ã–±–∫–∏
            fish.classList.add('jump-fish');
            
            await sendToServer('catch_fish');
            
            setTimeout(() => {
                fish.classList.remove('jump-fish');
                btn.disabled = false;
                status.innerText = "–£—Å–ø–µ—à–Ω—ã–π —É–ª–æ–≤!";
            }, 800);

        }, 3500);
    }

    async function sendToServer(act) {
        const user = tg.initDataUnsafe?.user;
        if (!user) return;
        
        try {
            await fetch(SERVER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: user.id, action: act })
            });
        } catch (e) { console.error("Error:", e); }
    }
</script>

</body>
</html>
