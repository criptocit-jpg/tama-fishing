<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tamacoin Fishing</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #070b1a; color: white; font-family: sans-serif; overflow: hidden; }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-120px); background: gold; color: #000; padding: 10px 20px; border-radius: 50px; font-weight: bold; z-index: 10000; transition: 0.5s; }
        #toast.show { transform: translateX(-50%) translateY(0); }
        
        .page { display: none; height: 100vh; flex-direction: column; padding: 20px; box-sizing: border-box; overflow-y: auto; padding-bottom: 100px; }
        .page.active { display: flex; }
        
        .balance-card { text-align: center; margin-bottom: 20px; }
        .balance-val { font-size: 36px; color: gold; font-weight: 900; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .card { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 15px; border: 1px solid #333; text-align: center; }
        
        .btn-action { background: #0288d1; border: none; padding: 18px; border-radius: 15px; color: white; font-weight: bold; width: 100%; margin: 10px 0; box-shadow: 0 4px 0 #01579b; font-size: 16px; transition: 0.1s; }
        .btn-action:active { transform: translateY(4px); box-shadow: none; }
        
        #fishAnim { width: 150px; display: none; margin: 20px auto; }
        
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: #000; display: flex; border-top: 1px solid #333; z-index: 1000; }
        .nav-item { flex: 1; text-align: center; display: flex; flex-direction: column; justify-content: center; font-size: 12px; color: #555; cursor: pointer; }
        .nav-item.active { color: gold; font-weight: bold; }

        /* –ú–æ–¥–∞–ª–∫–∞ –∫–æ—Ä–æ–±–æ–∫ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .box-container { display: flex; justify-content: space-around; width: 100%; margin: 20px 0; }
        .box-item { font-size: 60px; cursor: pointer; transition: 0.3s; }
        
        input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #444; background: #111; color: white; margin: 10px 0; box-sizing: border-box; }
    </style>
</head>
<body>
    <div id="toast"></div>

    <div id="p-game" class="page active">
        <div class="balance-card">
            <small>–í–ê–® –ë–ê–õ–ê–ù–°</small>
            <div class="balance-val"><span id="b1">0.00</span> TC</div>
        </div>
        
        <div class="stat-grid">
            <div class="card">‚ö° –≠–ù–ï–†–ì–ò–Ø: <span id="u-en">0</span></div>
            <div class="card">üì¶ –Ø–©–ò–ö–ò: <span id="u-boxes">0</span></div>
        </div>

        <div style="text-align: center;">
            <img src="fish_anim.webp" id="fishAnim" alt="Fishing...">
            <button id="openBoxBtn" class="btn-action" style="background: gold; color: black; display: none;" onclick="showBoxModal()">–û–¢–ö–†–´–¢–¨ –Ø–©–ò–ö üéÅ</button>
            <button class="btn-action" onclick="doFish()">–ó–ê–ë–†–û–°–ò–¢–¨ –£–î–û–ß–ö–£ üé£</button>
        </div>
    </div>

    <div id="p-menu" class="page">
        <h3>üéí –†–Æ–ö–ó–ê–ö –ò –ú–ê–ì–ê–ó–ò–ù</h3>
        <div class="card" style="margin-bottom: 15px;">
            –£ –≤–∞—Å —Ä—ã–±—ã: <span id="u-fish">0</span> –∫–≥
            <button class="btn-action" style="background: #4CAF50;" onclick="doAction('sell_fish')">–ü–†–û–î–ê–¢–¨ –í–°–Æ –†–´–ë–£</button>
        </div>
        
        <h4>–ú–ê–ì–ê–ó–ò–ù (STARS)</h4>
        <button class="btn-action" onclick="doAction('buy_stars', {id: 'titan_line'})">–¢–∏—Ç–∞–Ω–æ–≤–∞—è –ª–µ—Å–∫–∞ (50‚≠ê)</button>
        <button class="btn-action" onclick="doAction('buy_stars', {id: 'gold_bait'})">–ó–æ–ª–æ—Ç–∞—è –∫–∞—à–∞ (100‚≠ê)</button>
        
        <h4>–í–´–í–û–î –°–†–ï–î–°–¢–í</h4>
        <input type="text" id="walletAddr" placeholder="–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ TON">
        <input type="number" id="withdrawAmt" placeholder="–°—É–º–º–∞ (–º–∏–Ω. 30,000)">
        <button class="btn-action" style="background: #f44336;" onclick="requestWithdraw()">–í–´–í–ï–°–¢–ò TC</button>
    </div>

    <div id="p-top" class="page">
        <h3>üèÜ –¢–û–ü 10 –†–´–ë–ê–ö–û–í</h3>
        <div id="top-list">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</div>
    </div>

    <div id="boxModal" class="modal">
        <div style="text-align: center; width: 100%;">
            <h2>–í–´–ë–ï–†–ò –ö–û–†–û–ë–ö–£</h2>
            <div class="box-container">
                <div class="box-item" onclick="pickBox(this)">üéÅ</div>
                <div class="box-item" onclick="pickBox(this)">üéÅ</div>
                <div class="box-item" onclick="pickBox(this)">üéÅ</div>
            </div>
            <p id="box-status" style="color: gold;"></p>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="tab('game', this)">üéÆ –ò–ì–†–ê</div>
        <div class="nav-item" onclick="tab('menu', this)">üéí –ú–ï–ù–Æ</div>
        <div class="nav-item" onclick="tab('top', this)">üèÜ –¢–û–ü</div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    const url = 'https://tama-bot-server.onrender.com/api/action';
    
    tg.ready();
    tg.expand();

    function showToast(txt) {
        const t = document.getElementById('toast');
        t.innerText = txt;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function load() {
        try {
            const userId = tg.initDataUnsafe?.user?.id || "7883085758";
            const r = await fetch(`${url}?userId=${userId}`);
            const d = await r.json();
            updateUI(d);
        } catch(e) {
            console.error("Load error", e);
            showToast("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª–µ–π
    function updateUI(d) {
        if (!d) return;
        document.getElementById('b1').innerText = Number(d.balance || 0).toFixed(2);
        document.getElementById('u-en').innerText = d.energy || 0;
        document.getElementById('u-boxes').innerText = d.boxes || 0;
        document.getElementById('u-fish').innerText = d.fish || 0;
        
        const openBoxBtn = document.getElementById('openBoxBtn');
        if (openBoxBtn) openBoxBtn.style.display = (d.boxes > 0) ? 'block' : 'none';

        if (d.top) {
            const topList = document.getElementById('top-list');
            topList.innerHTML = d.top.map((u, i) => `
                <div class="card" style="margin-bottom: 5px; display: flex; justify-content: space-between;">
                    <span>${i+1}. ${u.n}</span>
                    <span style="color: gold;">${Math.floor(u.b)} TC</span>
                </div>
            `).join('');
        }
    }

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
    async function doAction(act, extra = {}) {
        try {
            const userId = tg.initDataUnsafe?.user?.id || "7883085758";
            const userName = tg.initDataUnsafe?.user?.first_name || "–†—ã–±–∞–∫";
            
            const r = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, userName, action: act, ...extra })
            });
            const d = await r.json();
            if (d.msg) showToast(d.msg);
            updateUI(d);
        } catch(e) {
            showToast("–û—à–∏–±–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è");
        }
    }

    function doFish() {
        const img = document.getElementById('fishAnim');
        img.style.display = 'block';
        setTimeout(() => {
            img.style.display = 'none';
            doAction('catch_fish');
        }, 1100);
    }

    function showBoxModal() {
        document.getElementById('boxModal').style.display = 'flex';
        document.getElementById('box-status').innerText = "–ù–∞–∂–º–∏ –Ω–∞ –ª—é–±—É—é –∫–æ—Ä–æ–±–∫—É!";
    }

    function pickBox(el) {
        el.innerText = "‚ú®";
        setTimeout(() => {
            doAction('open_box');
            document.getElementById('boxModal').style.display = 'none';
            el.innerText = "üéÅ";
        }, 1000);
    }

    function requestWithdraw() {
        const wallet = document.getElementById('walletAddr').value;
        const amount = document.getElementById('withdrawAmt').value;
        if (!wallet || amount < 30000) return showToast("–ú–∏–Ω–∏–º—É–º 30,000 TC –∏ –∞–¥—Ä–µ—Å TON!");
        doAction('withdraw', { wallet, amount: parseFloat(amount) });
    }

    function tab(name, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('p-' + name).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
    }

    load();
    setInterval(load, 30000); // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑ –≤ 30 —Å–µ–∫
</script>
</body>
</html>
