<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tamacoin Fishing Gold</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --gold: #FFD700; --gold-dark: #B8860B; --bg: #050810;
            --glass: rgba(255, 255, 255, 0.06); --glass-border: rgba(255, 255, 255, 0.12);
            --blue: #0088CC; --blue-dark: #005580; --red: #e91e63; --green: #4caf50;
        }
        body { margin: 0; padding: 0; background: var(--bg); color: white; font-family: -apple-system, system-ui; overflow: hidden; user-select: none; }
        #toast { position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-150%); background: var(--gold); color: #000; padding: 14px 28px; border-radius: 30px; font-weight: 800; z-index: 10000; transition: 0.4s; }
        #toast.show { transform: translateX(-50%) translateY(0); }
        #wood-alert { position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%) translateY(200%); background: linear-gradient(90deg, #5d4037, #3e2723); color: #d7ccc8; padding: 15px 30px; border-radius: 18px; transition: 0.5s; z-index: 99; text-align: center; }
        #wood-alert.show { transform: translateX(-50%) translateY(0); }
        .page { display: none; height: 100vh; flex-direction: column; padding: 25px 20px; box-sizing: border-box; }
        .page.active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header-info { text-align: center; }
        .lvl-tag { background: var(--gold); color: #000; padding: 2px 12px; border-radius: 10px; font-size: 10px; font-weight: 900; }
        .balance-val { font-size: 44px; font-weight: 900; }
        .balance-val span { color: var(--gold); }
        .stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 10px 0; }
        .stat-item { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 18px; padding: 10px; text-align: center; backdrop-filter: blur(10px); }
        .fishing-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; background: rgba(0,0,0,0.15); border-radius: 25px; }
        #fishAnim { width: 80%; display: none; animation: fishPop 0.4s ease; }
        @keyframes fishPop { from { transform: scale(0.5); } to { transform: scale(1); } }
        #captcha-bag { position: absolute; width: 75px; display: none; z-index: 101; filter: drop-shadow(0 0 20px var(--gold)); }
        .btn { border: none; border-radius: 22px; color: white; font-size: 18px; font-weight: 800; width: 100%; padding: 18px; cursor: pointer; }
        .btn-blue { background: var(--blue); margin-bottom: 80px; }
        .btn-gold { background: var(--gold); color: #000; margin-bottom: 10px; }
        .navbar { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: rgba(5,8,16,0.95); display: flex; border-top: 1px solid var(--glass-border); }
        .nav-link { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #556080; text-decoration: none; font-size: 10px; }
        .nav-link.active { color: var(--gold); }
        .section { background: var(--glass); border-radius: 15px; margin-bottom: 10px; }
        .section-header { padding: 15px; display: flex; justify-content: space-between; }
        .section-content { display: none; padding: 15px; background: rgba(0,0,0,0.2); }
        .section.open .section-content { display: block; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; background: #000; border: 1px solid var(--glass-border); color: #fff; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="toast"></div>
    <div id="wood-alert"></div>

    <div id="game" class="page active">
        <div class="header-info">
            <div id="u-lvl" class="lvl-tag">–ó–ê–ì–†–£–ó–ö–ê...</div>
            <div class="balance-val" id="b-container"><span id="b1">0</span> TC</div>
            <div style="font-size:14px">STARS: <b id="s1">0</b></div>
        </div>
        <div class="stats">
            <div class="stat-item"><small>–≠–ù–ï–†–ì–ò–Ø</small><b id="u-en">0</b></div>
            <div class="stat-item"><small>–£–î–û–ß–ö–ê</small><b id="u-dur">0%</b></div>
            <div class="stat-item"><small>–Ø–©–ò–ö–ò</small><b id="u-box">0</b></div>
        </div>
        <div class="fishing-area" id="lake-zone">
            <img src="https://cdn-icons-png.flaticon.com/512/2953/2953363.png" id="captcha-bag" onclick="catchBag()">
            <img src="fish_anim.webp" id="fishAnim">
        </div>
        <button id="btn-daily" class="btn btn-gold" onclick="doAction('get_daily')">–ë–û–ù–£–° üéÅ</button>
        <button id="cast-btn" class="btn btn-blue" onclick="startFishing()">–ó–ê–ë–†–û–°–ò–¢–¨ üé£</button>
    </div>

    <div id="menu" class="page">
        <div class="section" onclick="this.classList.toggle('open')">
            <div class="section-header"><span>üêü –£–õ–û–í: <b id="u-fish">0</b> –∫–≥</span><span>‚ñº</span></div>
            <div class="section-content"><button class="btn btn-gold" onclick="doAction('sell_fish')">–ü–†–û–î–ê–¢–¨</button></div>
        </div>
        <div class="section" onclick="this.classList.toggle('open')">
            <div class="section-header"><span>üõ†Ô∏è –ú–ê–°–¢–ï–†–°–ö–ê–Ø</span><span>‚ñº</span></div>
            <div class="section-content"><button class="btn btn-gold" onclick="doAction('repair')">–ü–û–ß–ò–ù–ò–¢–¨ (50 TC)</button></div>
        </div>
        <div class="section" onclick="this.classList.toggle('open')">
            <div class="section-header"><span>üõí –ú–ê–ì–ê–ó–ò–ù</span><span>‚ñº</span></div>
            <div class="section-content">
                <button onclick="doAction('buy_item', {itemId:'energy_drink'})">–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫ (100 TC)</button>
                <button onclick="doAction('buy_item', {itemId:'safe_ball'})">–ú—è—á–∏–∫ (50 TC)</button>
            </div>
        </div>
        <div class="section" onclick="this.classList.toggle('open')">
            <div class="section-header"><span>üí≥ –í–´–í–û–î</span><span>‚ñº</span></div>
            <div class="section-content">
                <input type="text" id="wallet" placeholder="TON –ê–¥—Ä–µ—Å">
                <input type="number" id="amount" placeholder="–°—É–º–º–∞ (30–∫+)">
                <button class="btn btn-blue" onclick="withdraw()">–í–´–í–ï–°–¢–ò</button>
            </div>
        </div>
    </div>

    <div id="top" class="page"><h1>üèÜ –¢–û–ü-10</h1><div id="top-list"></div></div>

    <nav class="navbar">
        <a href="#" class="nav-link active" onclick="showPage('game', this)"><span>üéÆ</span>–ò–≥—Ä–∞</a>
        <a href="#" class="nav-link" onclick="showPage('menu', this)"><span>üéí</span>–ú–µ–Ω—é</a>
        <a href="#" class="nav-link" onclick="showPage('top', this)"><span>üèÜ</span>–¢–æ–ø</a>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        const API_URL = 'https://tama-bot-server.onrender.com/api/action'; 
        let currentCastCount = 0;

        tg.ready(); tg.expand();

        function showToast(text) {
            const t = document.getElementById('toast');
            t.innerText = text; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function showWood(text) {
            const w = document.getElementById('wood-alert');
            w.innerText = text; w.classList.add('show');
            setTimeout(() => w.classList.remove('show'), 3000);
        }

        function showPage(pageId, navEl) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            navEl.classList.add('active');
        }

        async function doAction(action, extra = {}) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: tg.initDataUnsafe?.user?.id || "7883085758",
                        userName: tg.initDataUnsafe?.user?.first_name || "–†—ã–±–∞–∫",
                        action, ...extra
                    })
                });
                const data = await response.json();
                if(data.msg && action !== 'load_data') showToast(data.msg);
                updateUI(data);
            } catch(e) { console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
        }

        function updateUI(d) {
            if(!d) return;
            document.getElementById('b1').innerText = Math.floor(d.b || 0);
            document.getElementById('s1').innerText = Math.floor(d.s || 0);
            document.getElementById('u-en').innerText = Math.floor(d.energy || 0);
            document.getElementById('u-dur').innerText = (d.durability || 0) + '%';
            document.getElementById('u-box').innerText = d.boxes || 0;
            document.getElementById('u-fish').innerText = (d.fish || 0).toFixed(2);
            document.getElementById('u-lvl').innerText = d.level || "–°–ê–õ–ê–ì–ê";
            currentCastCount = d.castCount || 0;
            if(d.top) {
                document.getElementById('top-list').innerHTML = d.top.map((u, i) => `<div>${i+1}. ${u.n} - ${u.b} TC</div>`).join('');
            }
        }

        function startFishing() {
            if ((currentCastCount + 1) % 5 === 0) {
                const bag = document.getElementById('captcha-bag');
                bag.style.display = 'block';
                bag.style.left = '50%'; bag.style.top = '50%';
                document.getElementById('cast-btn').disabled = true;
            } else {
                const anim = document.getElementById('fishAnim');
                anim.style.display = 'block';
                setTimeout(() => { anim.style.display = 'none'; doAction('catch_fish'); }, 1200);
            }
        }

        function catchBag() {
            document.getElementById('captcha-bag').style.display = 'none';
            document.getElementById('cast-btn').disabled = false;
            doAction('catch_fish', {captchaPassed: true});
        }

        function withdraw() {
            const w = document.getElementById('wallet').value;
            const a = document.getElementById('amount').value;
            doAction('withdraw', {wallet: w, amount: parseFloat(a)});
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–∑ –≤ 10 —Å–µ–∫—É–Ω–¥ (–Ω–µ —á–∞—â–µ!)
        setInterval(() => { doAction('load_data'); }, 10000);
        doAction('load_data');
    </script>
</body>
</html>
